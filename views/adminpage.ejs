<!doctype html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Admin E-Commerce - Giegiebone</title>
    <style>
        :root {
            --sage-500: #9CAF88;
            --sage-600: #88a878;
            --bg: #ffffff;
            --muted: #6b6b6b;
            --accent: var(--sage-500);
        }
        * {
            box-sizing: border-box;
            font-family: Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }
        body {
            margin: 0;
            background: var(--bg);
            color: #222;
        }
        header {
            background: linear-gradient(90deg, var(--sage-500), var(--sage-600));
            color: #fff;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        header h1 {
            margin: 0;
            font-size: 1.15rem;
        }
        .container {
            display: flex;
            height: calc(100vh - 64px);
        }
        aside {
            width: 240px;
            background: #f7faf7;
            border-right: 1px solid #e6efe6;
            padding: 1rem;
        }
        nav a {
            display: block;
            padding: .6rem .6rem;
            border-radius: 6px;
            color: #163f2e;
            text-decoration: none;
            margin-bottom: .35rem;
        }
        nav a.active, nav a:hover {
            background: var(--accent);
            color: #fff;
        }
        main {
            flex: 1;
            padding: 1rem;
            overflow: auto;
        }
        .card {
            background: #fff;
            border: 1px solid #e6efe6;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.02);
        }
        .row {
            display: flex;
            gap: 1rem;
        }
        .col {
            flex: 1;
        }
        .btn {
            background: var(--accent);
            color: #fff;
            padding: .5rem .75rem;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
        }
        .btn.ghost {
            background: transparent;
            color: var(--accent);
            border: 1px solid var(--accent);
        }
        .btn-danger {
            background: #dc3545;
            color: white;
        }
        .btn-success {
            background: #28a745;
            color: white;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: .5rem .6rem;
            border-bottom: 1px solid #f0f4f0;
            text-align: left;
        }
        th {
            background: #fbfff9;
            color: var(--muted);
            font-weight: 600;
        }
        .muted {
            color: var(--muted);
            font-size: .95rem;
        }
        .form-row {
            display: flex;
            gap: .5rem;
            margin-bottom: .5rem;
        }
        input, select, textarea {
            padding: .45rem .5rem;
            border: 1px solid #e0e8df;
            border-radius: 6px;
            flex: 1;
        }
        .small {
            width: 140px;
        }
        .toolbar {
            display: flex;
            gap: .5rem;
            align-items: center;
        }
        .stats {
            display: flex;
            gap: 1rem;
        }
        .stat {
            background: linear-gradient(180deg, #fff, #fbfff9);
            padding: .6rem;
            border-radius: 8px;
            flex: 1;
            border: 1px solid #eef6ef;
        }
        .right {
            margin-left: auto;
        }
        .text-sm {
            font-size: .9rem;
        }
        .text-muted {
            color: var(--muted);
        }
        .flex-center {
            display: flex;
            align-items: center;
            gap: .5rem;
        }
        .product-image {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 5px;
        }
        .badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .badge-success {
            background: #d1f7c4;
            color: #0e6245;
        }
        .badge-warning {
            background: #fff2cc;
            color: #996b00;
        }
        .badge-danger {
            background: #ffd1d9;
            color: #a4262c;
        }
        .badge-info {
            background: #ccf0ff;
            color: #0066b8;
        }
        /* modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.35);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 1.5rem;
            border-radius: 8px;
            min-width: 320px;
            max-width: 680px;
            max-height: 90vh;
            overflow-y: auto;
        }
        @media (max-width: 800px) {
            aside { display: none; }
            .container { flex-direction: column; height: auto; }
        }
    </style>
</head>
<body>
    <header>
        <h1>Admin Panel â€” Giegiebone Official</h1>
        <div class="flex-center">
            <div class="text-sm">Login sebagai: <strong><%= user.username %></strong></div>
            <a href="/logout" class="btn btn-danger" style="margin-left: 1rem;">Logout</a>
        </div>
    </header>
    
    <div class="container">
        <aside>
            <nav>
                <a href="#dashboard" class="active" data-section="dashboard">Dashboard</a>
                <a href="#products" data-section="products">Kelola Produk</a>
                <a href="#users" data-section="users">Kelola User</a>
                <a href="#orders" data-section="orders">Pesanan</a>
            </nav>
            <hr>
            <div class="muted">Quick Actions</div>
            <div style="margin-top: .6rem">
                <button class="btn" id="btn-add-product">+ Tambah Produk</button>
            </div>
        </aside>

        <main>
            <!-- Dashboard Section -->
            <section id="dashboard" class="card section">
                <h2>Dashboard</h2>
                <div class="stats" style="margin-top: 1rem;">
                    <div class="stat">
                        <div class="muted">Total Produk</div>
                        <div style="font-size: 1.3rem; font-weight: 700;"><%= stats.totalProducts %></div>
                    </div>
                    <div class="stat">
                        <div class="muted">Total User</div>
                        <div style="font-size: 1.3rem; font-weight: 700;"><%= stats.totalUsers %></div>
                    </div>
                    <div class="stat">
                        <div class="muted">Total Pendapatan</div>
                        <div style="font-size: 1.3rem; font-weight: 700;">Rp 0</div>
                    </div>
                    <div class="stat">
                        <div class="muted">Pesanan Hari Ini</div>
                        <div style="font-size: 1.3rem; font-weight: 700;">0</div>
                    </div>
                </div>
                
                <div style="margin-top: 1.5rem;">
                    <h3>Aktivitas Terbaru</h3>
                    <p class="text-muted">Selamat datang di admin panel Giegiebone. Gunakan menu di samping untuk mengelola toko.</p>
                </div>
            </section>

            <!-- Products Section -->
            <section id="products" class="card section" style="display:none">
                <div style="display:flex;align-items:center;justify-content:space-between">
                    <h2>Kelola Produk</h2>
                    <div>
                        <button class="btn btn-success" id="btn-open-add">+ Tambah Produk</button>
                    </div>
                </div>
                <div style="margin-top:.75rem">
                    <table id="products-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Gambar</th>
                                <th>Nama</th>
                                <th>Stok</th>
                                <th>Harga</th>
                                <th>Kategori</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (products && products.length > 0) { %>
                                <% for (let i = 0; i < products.length; i++) { %>
                                    <tr>
                                        <td><%= products[i].product_id %></td>
                                        <td>
                                            <% if (products[i].image) { %>
                                                <img src="<%= products[i].image %>" class="product-image" alt="<%= products[i].name %>">
                                            <% } else { %>
                                                <div class="product-image" style="background: #f0f4f0; display: flex; align-items: center; justify-content: center; color: #999;">
                                                    <i class="fas fa-image"></i>
                                                </div>
                                            <% } %>
                                        </td>
                                        <td><%= products[i].name %></td>
                                        <td>
                                            <span class="badge <%= products[i].stock > 0 ? 'badge-success' : 'badge-danger' %>">
                                                <%= products[i].stock %>
                                            </span>
                                        </td>
                                        <td>Rp <%= Number(products[i].price).toLocaleString('id-ID') %></td>
                                        <td><%= products[i].category || 'Umum' %></td>
                                        <td>
                                            <button class="btn ghost edit-product" data-id="<%= products[i].product_id %>">Edit</button>
                                            <button class="btn btn-danger delete-product" data-id="<%= products[i].product_id %>" data-name="<%= products[i].name %>">Hapus</button>
                                        </td>
                                    </tr>
                                <% } %>
                            <% } else { %>
                                <tr>
                                    <td colspan="7" class="text-center text-muted">Belum ada produk</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="card section" style="display:none">
                <h2>Kelola User</h2>
                <div style="margin-top:.75rem">
                    <table id="users-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Username</th>
                                <th>Alamat</th>
                                <th>Role</th>
                                <th>Tanggal Daftar</th>
                                <th>Aksi</th>
                            </tr>
                        </thead>
                        <tbody>
                            <% if (users && users.length > 0) { %>
                                <% for (let i = 0; i < users.length; i++) { %>
                                    <tr>
                                        <td><%= users[i].user_id %></td>
                                        <td><%= users[i].username %></td>
                                        <td><%= users[i].address || '-' %></td>
                                        <td>
                                            <% if (users[i].role === 'admin') { %>
                                                <span class="badge badge-info">Admin</span>
                                            <% } else { %>
                                                <span class="badge badge-success">User</span>
                                            <% } %>
                                        </td>
                                        <td><%= new Date(users[i].created_at).toLocaleDateString('id-ID') %></td>
                                        <td>
                                            <% if (users[i].username !== 'admin') { %>
                                                <button class="btn btn-danger delete-user" data-id="<%= users[i].user_id %>" data-name="<%= users[i].username %>">Hapus</button>
                                            <% } else { %>
                                                <span class="text-muted">Admin Utama</span>
                                            <% } %>
                                        </td>
                                    </tr>
                                <% } %>
                            <% } else { %>
                                <tr>
                                    <td colspan="6" class="text-center text-muted">Belum ada user</td>
                                </tr>
                            <% } %>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Orders Section -->
            <section id="orders" class="card section" style="display:none">
                <h2>Pesanan</h2>
                <div style="margin-top:.75rem">
                    <p class="text-muted">Fitur pesanan akan segera tersedia.</p>
                    <!-- Nanti bisa diisi dengan data pesanan dari database -->
                </div>
            </section>
        </main>
    </div>

    <!-- Modal Add/Edit Product -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <h3 id="modalTitle">Tambah Produk Baru</h3>
            <div style="margin-top: 1rem;">
                <div class="form-row">
                    <input type="text" id="productName" placeholder="Nama produk *" required>
                </div>
                <div class="form-row">
                    <input type="number" id="productPrice" placeholder="Harga (Rp) *" required min="0">
                </div>
                <div class="form-row">
                    <input type="number" id="productStock" placeholder="Stok *" required min="0">
                </div>
                <div class="form-row">
                    <input type="text" id="productCategory" placeholder="Kategori">
                </div>
                <div class="form-row">
                    <textarea id="productDescription" placeholder="Deskripsi" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <label for="productImage" style="font-size: 14px; margin-bottom: 5px;">Gambar Produk</label>
                    <input type="file" id="productImage" accept="image/*">
                </div>
                <div style="display:flex;justify-content:flex-end;gap:.5rem;margin-top:1rem">
                    <button class="btn ghost" id="modalCancel">Batal</button>
                    <button class="btn" id="modalSave">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        // Navigation
        document.querySelectorAll('nav a').forEach(a => {
            a.addEventListener('click', function(e) {
                e.preventDefault();
                document.querySelectorAll('nav a').forEach(x => x.classList.remove('active'));
                this.classList.add('active');
                
                const section = this.dataset.section;
                document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
                document.getElementById(section).style.display = 'block';
            });
        });

        // Modal functions
        const modal = document.getElementById('productModal');
        const modalCancel = document.getElementById('modalCancel');
        const modalSave = document.getElementById('modalSave');
        let editingProductId = null;

        // Open modal for adding product
        document.getElementById('btn-open-add').addEventListener('click', () => openProductModal());
        document.getElementById('btn-add-product').addEventListener('click', () => {
            document.querySelectorAll('nav a').forEach(x => x.classList.remove('active'));
            document.querySelector('nav a[data-section="products"]').classList.add('active');
            document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
            document.getElementById('products').style.display = 'block';
            openProductModal();
        });

        function openProductModal(product = null) {
            document.getElementById('modalTitle').textContent = product ? 'Edit Produk' : 'Tambah Produk Baru';
            
            if (product) {
                editingProductId = product.product_id;
                document.getElementById('productName').value = product.name || '';
                document.getElementById('productPrice').value = product.price || '';
                document.getElementById('productStock').value = product.stock || '';
                document.getElementById('productCategory').value = product.category || '';
                document.getElementById('productDescription').value = product.description || '';
            } else {
                editingProductId = null;
                document.getElementById('productName').value = '';
                document.getElementById('productPrice').value = '';
                document.getElementById('productStock').value = '';
                document.getElementById('productCategory').value = '';
                document.getElementById('productDescription').value = '';
                document.getElementById('productImage').value = '';
            }
            
            modal.style.display = 'flex';
        }

        // Close modal
        modalCancel.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        // Save product
        modalSave.addEventListener('click', () => {
            const name = document.getElementById('productName').value.trim();
            const price = document.getElementById('productPrice').value;
            const stock = document.getElementById('productStock').value;
            const category = document.getElementById('productCategory').value.trim();
            const description = document.getElementById('productDescription').value.trim();
            const imageFile = document.getElementById('productImage').files[0];
            
            if (!name || !price || !stock) {
                alert('Harap isi semua field yang wajib diisi!');
                return;
            }
            
            if (editingProductId) {
                // Edit existing product
                const productData = {
                    name: name,
                    price: parseFloat(price),
                    stock: parseInt(stock),
                    category: category,
                    description: description
                };
                
                fetch(`/api/products/${editingProductId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(productData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // If there's a new image, upload it
                        if (imageFile) {
                            const imageFormData = new FormData();
                            imageFormData.append('image', imageFile);
                            
                            fetch(`/api/products/${editingProductId}/image`, {
                                method: 'PUT',
                                body: imageFormData
                            })
                            .then(response => response.json())
                            .then(imageData => {
                                if (imageData.success) {
                                    showSuccess('Produk berhasil diperbarui!');
                                    setTimeout(() => location.reload(), 1000);
                                } else {
                                    alert('Produk berhasil diperbarui, tetapi gambar gagal diupdate: ' + imageData.error);
                                    setTimeout(() => location.reload(), 1000);
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('Produk berhasil diperbarui, tetapi gambar gagal diupdate');
                                setTimeout(() => location.reload(), 1000);
                            });
                        } else {
                            showSuccess('Produk berhasil diperbarui!');
                            setTimeout(() => location.reload(), 1000);
                        }
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Gagal memperbarui produk');
                });
            } else {
                // Add new product
                const formData = new FormData();
                formData.append('name', name);
                formData.append('price', price);
                formData.append('stock', stock);
                formData.append('category', category);
                formData.append('description', description);
                if (imageFile) {
                    formData.append('image', imageFile);
                }
                
                fetch('/api/products', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showSuccess('Produk berhasil ditambahkan!');
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        alert('Error: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Gagal menambahkan produk');
                });
            }
            
            modal.style.display = 'none';
        });

        // Edit product buttons
        document.querySelectorAll('.edit-product').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                
                fetch(`/api/products/${productId}`)
                    .then(response => response.json())
                    .then(product => {
                        openProductModal(product);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Gagal mengambil data produk');
                    });
            });
        });

        // Delete product buttons
        document.querySelectorAll('.delete-product').forEach(btn => {
            btn.addEventListener('click', function() {
                const productId = this.dataset.id;
                const productName = this.dataset.name;
                
                if (confirm(`Apakah Anda yakin ingin menghapus produk: "${productName}"?`)) {
                    fetch(`/api/products/${productId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('Produk berhasil dihapus!');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Gagal menghapus produk');
                    });
                }
            });
        });

        // Delete user buttons
        document.querySelectorAll('.delete-user').forEach(btn => {
            btn.addEventListener('click', function() {
                const userId = this.dataset.id;
                const userName = this.dataset.name;
                
                if (confirm(`Apakah Anda yakin ingin menghapus user: "${userName}"?`)) {
                    fetch(`/api/users/${userId}`, {
                        method: 'DELETE'
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            showSuccess('User berhasil dihapus!');
                            setTimeout(() => location.reload(), 1000);
                        } else {
                            alert('Error: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('Gagal menghapus user');
                    });
                }
            });
        });

        // Helper function to show success message
        function showSuccess(message) {
            alert(message);
        }

        // Close modal when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
    </script>
</body>
</html>